[{"path":"fetcher/__init__.py","fileType":"py","lines":[{"lineNumber":1,"author":{"gitId":"Parcly-Taxel"},"content":"# This is presently an empty file"},{"lineNumber":2,"author":{"gitId":"Parcly-Taxel"},"content":"# There is no need to populate it"}],"authorContributionMap":{"Parcly-Taxel":2}},{"path":"fetcher/fetch-issues.py","fileType":"py","lines":[{"lineNumber":1,"author":{"gitId":"Parcly-Taxel"},"content":"#!/usr/bin/env python3.7"},{"lineNumber":2,"author":{"gitId":"Parcly-Taxel"},"content":"import json"},{"lineNumber":3,"author":{"gitId":"Parcly-Taxel"},"content":"import argparse"},{"lineNumber":4,"author":{"gitId":"Parcly-Taxel"},"content":"import requests"},{"lineNumber":5,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":6,"author":{"gitId":"Parcly-Taxel"},"content":"issues_query \u003d \"\"\""},{"lineNumber":7,"author":{"gitId":"Parcly-Taxel"},"content":"query($after: String, $owner: String!, $name: String!) {"},{"lineNumber":8,"author":{"gitId":"Parcly-Taxel"},"content":"repository(owner: $owner, name: $name) {"},{"lineNumber":9,"author":{"gitId":"Parcly-Taxel"},"content":"issues(first: 100, after: $after) {"},{"lineNumber":10,"author":{"gitId":"Parcly-Taxel"},"content":"nodes {title body labels(first: 10) {nodes {name color}}}"},{"lineNumber":11,"author":{"gitId":"Parcly-Taxel"},"content":"pageInfo {endCursor hasNextPage}}}}"},{"lineNumber":12,"author":{"gitId":"Parcly-Taxel"},"content":"\"\"\""},{"lineNumber":13,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":14,"author":{"gitId":"Parcly-Taxel"},"content":"# Adapted from https://gist.github.com/gbaman/b3137e18c739e0cf98539bf4ec4366ad"},{"lineNumber":15,"author":{"gitId":"Parcly-Taxel"},"content":"def query_graphql(query, variables, token):"},{"lineNumber":16,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Query GitHub\u0027s GraphQL API with the given query and variables."},{"lineNumber":17,"author":{"gitId":"Parcly-Taxel"},"content":"    The response JSON always has a \"data\" key; its value is returned"},{"lineNumber":18,"author":{"gitId":"Parcly-Taxel"},"content":"    as a dictionary.\"\"\""},{"lineNumber":19,"author":{"gitId":"Parcly-Taxel"},"content":"    header \u003d {\"Authorization\": f\"token {token}\"}"},{"lineNumber":20,"author":{"gitId":"Parcly-Taxel"},"content":"    r \u003d requests.post(\"https://api.github.com/graphql\","},{"lineNumber":21,"author":{"gitId":"Parcly-Taxel"},"content":"            json\u003d{\"query\": query, \"variables\": variables}, headers\u003dheader)"},{"lineNumber":22,"author":{"gitId":"Parcly-Taxel"},"content":"    r.raise_for_status()"},{"lineNumber":23,"author":{"gitId":"Parcly-Taxel"},"content":"    return r.json()[\"data\"]"},{"lineNumber":24,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":25,"author":{"gitId":"Parcly-Taxel"},"content":"def query_rest(method, endpoint, params, token, extra_headers\u003d{}):"},{"lineNumber":26,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Query GitHub\u0027s REST API with the given method, endpoint"},{"lineNumber":27,"author":{"gitId":"Parcly-Taxel"},"content":"    and parameters. Return the response JSON as a dictionary.\"\"\""},{"lineNumber":28,"author":{"gitId":"Parcly-Taxel"},"content":"    header \u003d {\"Authorization\": f\"token {token}\"}"},{"lineNumber":29,"author":{"gitId":"Parcly-Taxel"},"content":"    header.update(extra_headers)"},{"lineNumber":30,"author":{"gitId":"Parcly-Taxel"},"content":"    r \u003d requests.request(method, \"https://api.github.com\" + endpoint,"},{"lineNumber":31,"author":{"gitId":"Parcly-Taxel"},"content":"            json\u003dparams, headers\u003dheader)"},{"lineNumber":32,"author":{"gitId":"Parcly-Taxel"},"content":"    if not r.ok:"},{"lineNumber":33,"author":{"gitId":"Parcly-Taxel"},"content":"        print(r.headers)"},{"lineNumber":34,"author":{"gitId":"Parcly-Taxel"},"content":"        print(r.json())"},{"lineNumber":35,"author":{"gitId":"Parcly-Taxel"},"content":"        0 / 0"},{"lineNumber":36,"author":{"gitId":"Parcly-Taxel"},"content":"    return r.json()"},{"lineNumber":37,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":38,"author":{"gitId":"Parcly-Taxel"},"content":"def get_issue_data(path, token):"},{"lineNumber":39,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"If path is a JSON file (ending in .json), read that file. Otherwise,"},{"lineNumber":40,"author":{"gitId":"Parcly-Taxel"},"content":"    path must be a repository in owner/name format; save to issues.json"},{"lineNumber":41,"author":{"gitId":"Parcly-Taxel"},"content":"    as backup afterwards."},{"lineNumber":42,"author":{"gitId":"Parcly-Taxel"},"content":"    In either case, return (1) a list of 3-tuples (title, body, label names)"},{"lineNumber":43,"author":{"gitId":"Parcly-Taxel"},"content":"    for each issue in the repository, and (2) a mapping from names to colours"},{"lineNumber":44,"author":{"gitId":"Parcly-Taxel"},"content":"    for the labels. GraphQL is used in this stage, and only this stage.\"\"\""},{"lineNumber":45,"author":{"gitId":"Parcly-Taxel"},"content":"    if path.endswith(\".json\"):"},{"lineNumber":46,"author":{"gitId":"Parcly-Taxel"},"content":"        with open(path, \u0027r\u0027) as f:"},{"lineNumber":47,"author":{"gitId":"Parcly-Taxel"},"content":"            return json.load(f)"},{"lineNumber":48,"author":{"gitId":"Parcly-Taxel"},"content":"    owner, name \u003d path.split(\"/\")"},{"lineNumber":49,"author":{"gitId":"Parcly-Taxel"},"content":"    variables \u003d {\"owner\": owner, \"name\": name}"},{"lineNumber":50,"author":{"gitId":"Parcly-Taxel"},"content":"    issues, label_map, next_page \u003d [], {}, True"},{"lineNumber":51,"author":{"gitId":"Parcly-Taxel"},"content":"    while next_page:"},{"lineNumber":52,"author":{"gitId":"Parcly-Taxel"},"content":"        r \u003d query_graphql(issues_query, variables, token)[\"repository\"]"},{"lineNumber":53,"author":{"gitId":"Parcly-Taxel"},"content":"        for issue in r[\"issues\"][\"nodes\"]:"},{"lineNumber":54,"author":{"gitId":"Parcly-Taxel"},"content":"            labels \u003d issue[\"labels\"][\"nodes\"]"},{"lineNumber":55,"author":{"gitId":"Parcly-Taxel"},"content":"            label_map.update({x[\"name\"]: x[\"color\"] for x in labels})"},{"lineNumber":56,"author":{"gitId":"Parcly-Taxel"},"content":"            issue[\"labels\"] \u003d [x[\"name\"] for x in labels]"},{"lineNumber":57,"author":{"gitId":"Parcly-Taxel"},"content":"            issues.append({\"issue\": issue})"},{"lineNumber":58,"author":{"gitId":"Parcly-Taxel"},"content":"        print(f\"{len(issues)} issues received\")"},{"lineNumber":59,"author":{"gitId":"Parcly-Taxel"},"content":"        page_info \u003d r[\"issues\"][\"pageInfo\"]"},{"lineNumber":60,"author":{"gitId":"Parcly-Taxel"},"content":"        next_page \u003d page_info[\"hasNextPage\"]"},{"lineNumber":61,"author":{"gitId":"Parcly-Taxel"},"content":"        variables[\"after\"] \u003d page_info[\"endCursor\"]"},{"lineNumber":62,"author":{"gitId":"Parcly-Taxel"},"content":"    result \u003d (issues, label_map)"},{"lineNumber":63,"author":{"gitId":"Parcly-Taxel"},"content":"    with open(\"issues.json\", \u0027w\u0027) as f:"},{"lineNumber":64,"author":{"gitId":"Parcly-Taxel"},"content":"        json.dump(result, f, indent\u003d\"  \")"},{"lineNumber":65,"author":{"gitId":"Parcly-Taxel"},"content":"    return result"},{"lineNumber":66,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":67,"author":{"gitId":"Parcly-Taxel"},"content":"def create_labels(owner_name, labels, token):"},{"lineNumber":68,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Create all given labels not existing in the given repository"},{"lineNumber":69,"author":{"gitId":"Parcly-Taxel"},"content":"    (owner/name format). Return None.\"\"\""},{"lineNumber":70,"author":{"gitId":"Parcly-Taxel"},"content":"    r \u003d query_rest(\"GET\", f\"/repos/{owner_name}/labels?per_page\u003d100\", {}, token)"},{"lineNumber":71,"author":{"gitId":"Parcly-Taxel"},"content":"    existing \u003d {x[\"name\"]: x[\"color\"] for x in r}"},{"lineNumber":72,"author":{"gitId":"Parcly-Taxel"},"content":"    for (name, colour) in labels.items():"},{"lineNumber":73,"author":{"gitId":"Parcly-Taxel"},"content":"        if name in existing:"},{"lineNumber":74,"author":{"gitId":"Parcly-Taxel"},"content":"            continue"},{"lineNumber":75,"author":{"gitId":"Parcly-Taxel"},"content":"        query_rest(\"POST\", f\"/repos/{owner_name}/labels\","},{"lineNumber":76,"author":{"gitId":"Parcly-Taxel"},"content":"                {\"name\": name, \"color\": colour}, token)"},{"lineNumber":77,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":78,"author":{"gitId":"Parcly-Taxel"},"content":"def create_issues(owner_name, issues, token):"},{"lineNumber":79,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Create the given issues in the given repository (owner/name format)."},{"lineNumber":80,"author":{"gitId":"Parcly-Taxel"},"content":"    Return None.\"\"\""},{"lineNumber":81,"author":{"gitId":"Parcly-Taxel"},"content":"    N \u003d len(issues)"},{"lineNumber":82,"author":{"gitId":"Parcly-Taxel"},"content":"    for (n, issue) in enumerate(issues, 1):"},{"lineNumber":83,"author":{"gitId":"Parcly-Taxel"},"content":"        query_rest(\"POST\", f\"/repos/{owner_name}/import/issues\", issue, token,"},{"lineNumber":84,"author":{"gitId":"Parcly-Taxel"},"content":"                {\"Accept\": \"application/vnd.github.golden-comet-preview+json\"})"},{"lineNumber":85,"author":{"gitId":"Parcly-Taxel"},"content":"        if n % 10 \u003d\u003d 0:"},{"lineNumber":86,"author":{"gitId":"Parcly-Taxel"},"content":"            print(f\"{n}/{N} issues imported\")"},{"lineNumber":87,"author":{"gitId":"Parcly-Taxel"},"content":"        with open(\"remaining.json\", \u0027w\u0027) as f:"},{"lineNumber":88,"author":{"gitId":"Parcly-Taxel"},"content":"            json.dump((issues[n:], {}), f, indent\u003d\"  \")"},{"lineNumber":89,"author":{"gitId":"Parcly-Taxel"},"content":"    print(\"all done\")"},{"lineNumber":90,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":91,"author":{"gitId":"Parcly-Taxel"},"content":"def read_access_token(file):"},{"lineNumber":92,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"file contains a GitHub access token with repo permissions on"},{"lineNumber":93,"author":{"gitId":"Parcly-Taxel"},"content":"    its last line. Return this token.\"\"\""},{"lineNumber":94,"author":{"gitId":"Parcly-Taxel"},"content":"    with open(file, \u0027r\u0027) as f:"},{"lineNumber":95,"author":{"gitId":"Parcly-Taxel"},"content":"        return f.read().splitlines()[-1]"},{"lineNumber":96,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":97,"author":{"gitId":"Parcly-Taxel"},"content":"def main():"},{"lineNumber":98,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Fetch all issues from the given repository, saving their"},{"lineNumber":99,"author":{"gitId":"Parcly-Taxel"},"content":"    title, body and labels as a JSON file.\"\"\""},{"lineNumber":100,"author":{"gitId":"Parcly-Taxel"},"content":"    parser \u003d argparse.ArgumentParser(description\u003d\"Fetch all issues \""},{"lineNumber":101,"author":{"gitId":"Parcly-Taxel"},"content":"            \"from the given repository, writing title, body and labels \""},{"lineNumber":102,"author":{"gitId":"Parcly-Taxel"},"content":"            \"to issues.json.\")"},{"lineNumber":103,"author":{"gitId":"Parcly-Taxel"},"content":"    parser.add_argument(\"source\", help\u003d\"source repository in the form \""},{"lineNumber":104,"author":{"gitId":"Parcly-Taxel"},"content":"            \"owner/name (e.g. nus-cs2103-AY1920S1/ped-dev-response), \""},{"lineNumber":105,"author":{"gitId":"Parcly-Taxel"},"content":"            \"or path to JSON file (e.g. issues.json)\")"},{"lineNumber":106,"author":{"gitId":"Parcly-Taxel"},"content":"    parser.add_argument(\"destination\", help\u003d\"destination repository, \""},{"lineNumber":107,"author":{"gitId":"Parcly-Taxel"},"content":"            \"in the form owner/name\")"},{"lineNumber":108,"author":{"gitId":"Parcly-Taxel"},"content":"    parser.add_argument(\"credentials\", help\u003d\"credentials file, \""},{"lineNumber":109,"author":{"gitId":"Parcly-Taxel"},"content":"            \"same format as for fetch.py\")"},{"lineNumber":110,"author":{"gitId":"Parcly-Taxel"},"content":"    args \u003d parser.parse_args()"},{"lineNumber":111,"author":{"gitId":"Parcly-Taxel"},"content":"    TOKEN \u003d read_access_token(args.credentials)"},{"lineNumber":112,"author":{"gitId":"Parcly-Taxel"},"content":"    issues, labels \u003d get_issue_data(args.source, TOKEN)"},{"lineNumber":113,"author":{"gitId":"Parcly-Taxel"},"content":"    create_labels(args.destination, labels, TOKEN)"},{"lineNumber":114,"author":{"gitId":"Parcly-Taxel"},"content":"    create_issues(args.destination, issues, TOKEN)"},{"lineNumber":115,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":116,"author":{"gitId":"Parcly-Taxel"},"content":"if __name__ \u003d\u003d \"__main__\":"},{"lineNumber":117,"author":{"gitId":"Parcly-Taxel"},"content":"    main()"}],"authorContributionMap":{"Parcly-Taxel":117}},{"path":"fetcher/fetch.py","fileType":"py","lines":[{"lineNumber":1,"author":{"gitId":"Parcly-Taxel"},"content":"#!/usr/bin/env python3.7"},{"lineNumber":2,"author":{"gitId":"Parcly-Taxel"},"content":"import os"},{"lineNumber":3,"author":{"gitId":"Parcly-Taxel"},"content":"import csv"},{"lineNumber":4,"author":{"gitId":"Parcly-Taxel"},"content":"import shutil"},{"lineNumber":5,"author":{"gitId":"Parcly-Taxel"},"content":"import tempfile"},{"lineNumber":6,"author":{"gitId":"Parcly-Taxel"},"content":"import argparse"},{"lineNumber":7,"author":{"gitId":"Parcly-Taxel"},"content":"import multiprocessing"},{"lineNumber":8,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":9,"author":{"gitId":"Parcly-Taxel"},"content":"import pygit2"},{"lineNumber":10,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":11,"author":{"gitId":"Parcly-Taxel"},"content":"def clone_destination(owner_name, key):"},{"lineNumber":12,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"If the destination repository given by owner/name does not exist,"},{"lineNumber":13,"author":{"gitId":"Parcly-Taxel"},"content":"    clone it. key is a RemoteCallbacks object for authentication to GitHub."},{"lineNumber":14,"author":{"gitId":"Parcly-Taxel"},"content":"    Return a Repository object in any case.\"\"\""},{"lineNumber":15,"author":{"gitId":"Parcly-Taxel"},"content":"    name \u003d owner_name.partition(\"/\")[2]"},{"lineNumber":16,"author":{"gitId":"Parcly-Taxel"},"content":"    if os.path.exists(name):"},{"lineNumber":17,"author":{"gitId":"Parcly-Taxel"},"content":"        return pygit2.Repository(name)"},{"lineNumber":18,"author":{"gitId":"Parcly-Taxel"},"content":"    git_path \u003d f\"https://github.com/{owner_name}.git\""},{"lineNumber":19,"author":{"gitId":"Parcly-Taxel"},"content":"    return pygit2.clone_repository(git_path, name, callbacks\u003dkey)"},{"lineNumber":20,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":21,"author":{"gitId":"Parcly-Taxel"},"content":"def make_files_folder(repository):"},{"lineNumber":22,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Return a path to a folder called files in the given"},{"lineNumber":23,"author":{"gitId":"Parcly-Taxel"},"content":"    Repository object, making it if needed.\"\"\""},{"lineNumber":24,"author":{"gitId":"Parcly-Taxel"},"content":"    files_path \u003d os.path.join(repository.workdir, \"files\")"},{"lineNumber":25,"author":{"gitId":"Parcly-Taxel"},"content":"    os.makedirs(files_path, exist_ok\u003dTrue)"},{"lineNumber":26,"author":{"gitId":"Parcly-Taxel"},"content":"    return files_path"},{"lineNumber":27,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":28,"author":{"gitId":"Parcly-Taxel"},"content":"def clone_files(pair):"},{"lineNumber":29,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"pair \u003d (name, parent). Clone the named student\u0027s PE repository"},{"lineNumber":30,"author":{"gitId":"Parcly-Taxel"},"content":"    into parent and return (name, path), where path is name/files or"},{"lineNumber":31,"author":{"gitId":"Parcly-Taxel"},"content":"    None if the repository does not exist."},{"lineNumber":32,"author":{"gitId":"Parcly-Taxel"},"content":"    parent/name should not already exist.\"\"\""},{"lineNumber":33,"author":{"gitId":"Parcly-Taxel"},"content":"    name, parent \u003d pair"},{"lineNumber":34,"author":{"gitId":"Parcly-Taxel"},"content":"    try:"},{"lineNumber":35,"author":{"gitId":"Parcly-Taxel"},"content":"        git_path \u003d f\"git://github.com/{name}/pe.git\""},{"lineNumber":36,"author":{"gitId":"Parcly-Taxel"},"content":"        repo_path \u003d os.path.join(parent, name)"},{"lineNumber":37,"author":{"gitId":"Parcly-Taxel"},"content":"        pygit2.clone_repository(git_path, repo_path)"},{"lineNumber":38,"author":{"gitId":"Parcly-Taxel"},"content":"    except pygit2.GitError:"},{"lineNumber":39,"author":{"gitId":"Parcly-Taxel"},"content":"        return (name, None)"},{"lineNumber":40,"author":{"gitId":"Parcly-Taxel"},"content":"    files_path \u003d os.path.join(repo_path, \"files\")"},{"lineNumber":41,"author":{"gitId":"Parcly-Taxel"},"content":"    return (name, files_path if os.path.isdir(files_path) else None)"},{"lineNumber":42,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":43,"author":{"gitId":"Parcly-Taxel"},"content":"def transfer_files(src, dst):"},{"lineNumber":44,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Transfer all files from src into dst, returning any clashing"},{"lineNumber":45,"author":{"gitId":"Parcly-Taxel"},"content":"    filenames (not transferred after the first) as a list.\"\"\""},{"lineNumber":46,"author":{"gitId":"Parcly-Taxel"},"content":"    clashes \u003d []"},{"lineNumber":47,"author":{"gitId":"Parcly-Taxel"},"content":"    files_in_dst \u003d os.listdir(dst)"},{"lineNumber":48,"author":{"gitId":"Parcly-Taxel"},"content":"    for filename in os.listdir(src):"},{"lineNumber":49,"author":{"gitId":"Parcly-Taxel"},"content":"        full_filename \u003d os.path.join(src, filename)"},{"lineNumber":50,"author":{"gitId":"Parcly-Taxel"},"content":"        if filename in files_in_dst:"},{"lineNumber":51,"author":{"gitId":"Parcly-Taxel"},"content":"            clashes.append(full_filename)"},{"lineNumber":52,"author":{"gitId":"Parcly-Taxel"},"content":"        else:"},{"lineNumber":53,"author":{"gitId":"Parcly-Taxel"},"content":"            shutil.copy(full_filename, dst)"},{"lineNumber":54,"author":{"gitId":"Parcly-Taxel"},"content":"    return clashes"},{"lineNumber":55,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":56,"author":{"gitId":"Parcly-Taxel"},"content":"def get_user_and_filename(path):"},{"lineNumber":57,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Extract the user and filename from the full paths returned"},{"lineNumber":58,"author":{"gitId":"Parcly-Taxel"},"content":"    from transfer_files(), which indicate clashing filenames.\"\"\""},{"lineNumber":59,"author":{"gitId":"Parcly-Taxel"},"content":"    segments \u003d os.path.normpath(path).split(os.sep)"},{"lineNumber":60,"author":{"gitId":"Parcly-Taxel"},"content":"    return segments[-3] + \"/\" + segments[-1]"},{"lineNumber":61,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":62,"author":{"gitId":"Parcly-Taxel"},"content":"def dump_remaining_usernames(names):"},{"lineNumber":63,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Dump names yet to be processed into a backup file.\"\"\""},{"lineNumber":64,"author":{"gitId":"Parcly-Taxel"},"content":"    with open(\"remaining\", \u0027w\u0027) as f:"},{"lineNumber":65,"author":{"gitId":"Parcly-Taxel"},"content":"        for name in names:"},{"lineNumber":66,"author":{"gitId":"Parcly-Taxel"},"content":"            print(name, file\u003df)"},{"lineNumber":67,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":68,"author":{"gitId":"Parcly-Taxel"},"content":"def collate_files(names, endpoint, processes):"},{"lineNumber":69,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Given a sequence of GitHub usernames of students, clone their"},{"lineNumber":70,"author":{"gitId":"Parcly-Taxel"},"content":"    PE repositories and copy files into endpoint. Return a list of"},{"lineNumber":71,"author":{"gitId":"Parcly-Taxel"},"content":"    duplicate filenames found in the form username/filename."},{"lineNumber":72,"author":{"gitId":"Parcly-Taxel"},"content":"    The given number of processes will be used for cloning in parallel.\"\"\""},{"lineNumber":73,"author":{"gitId":"Parcly-Taxel"},"content":"    clashes \u003d []"},{"lineNumber":74,"author":{"gitId":"Parcly-Taxel"},"content":"    N \u003d len(names)"},{"lineNumber":75,"author":{"gitId":"Parcly-Taxel"},"content":"    left_names \u003d set(names)"},{"lineNumber":76,"author":{"gitId":"Parcly-Taxel"},"content":"    with tempfile.TemporaryDirectory() as tempdir, \\"},{"lineNumber":77,"author":{"gitId":"Parcly-Taxel"},"content":"            multiprocessing.Pool(processes\u003dprocesses) as pool:"},{"lineNumber":78,"author":{"gitId":"Parcly-Taxel"},"content":"        pairs \u003d [(name, tempdir) for name in names]"},{"lineNumber":79,"author":{"gitId":"Parcly-Taxel"},"content":"        results \u003d pool.imap(clone_files, pairs)"},{"lineNumber":80,"author":{"gitId":"Parcly-Taxel"},"content":"        for (n, (name, name_path)) in enumerate(results, 1):"},{"lineNumber":81,"author":{"gitId":"Parcly-Taxel"},"content":"            print(f\"{n}/{N} {name}\")"},{"lineNumber":82,"author":{"gitId":"Parcly-Taxel"},"content":"            left_names.remove(name)"},{"lineNumber":83,"author":{"gitId":"Parcly-Taxel"},"content":"            dump_remaining_usernames(left_names)"},{"lineNumber":84,"author":{"gitId":"Parcly-Taxel"},"content":"            if name_path is None:"},{"lineNumber":85,"author":{"gitId":"Parcly-Taxel"},"content":"                continue"},{"lineNumber":86,"author":{"gitId":"Parcly-Taxel"},"content":"            clashes +\u003d transfer_files(name_path, endpoint)"},{"lineNumber":87,"author":{"gitId":"Parcly-Taxel"},"content":"    return [get_user_and_filename(p) for p in clashes]"},{"lineNumber":88,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":89,"author":{"gitId":"Parcly-Taxel"},"content":"def commit_and_push(repository, author, email, message, key):"},{"lineNumber":90,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Commit the current working state of repository using the given"},{"lineNumber":91,"author":{"gitId":"Parcly-Taxel"},"content":"    author information and message. Then push changes to the remote"},{"lineNumber":92,"author":{"gitId":"Parcly-Taxel"},"content":"    using key (a RemoteCallbacks object) for authentication.\"\"\""},{"lineNumber":93,"author":{"gitId":"Parcly-Taxel"},"content":"    repository.index.add_all()"},{"lineNumber":94,"author":{"gitId":"Parcly-Taxel"},"content":"    repository.index.write()"},{"lineNumber":95,"author":{"gitId":"Parcly-Taxel"},"content":"    signature \u003d pygit2.Signature(author, email)"},{"lineNumber":96,"author":{"gitId":"Parcly-Taxel"},"content":"    tree \u003d repository.index.write_tree()"},{"lineNumber":97,"author":{"gitId":"Parcly-Taxel"},"content":"    repository.create_commit(\"HEAD\", signature, signature, message,"},{"lineNumber":98,"author":{"gitId":"Parcly-Taxel"},"content":"            tree, [repository.head.target])"},{"lineNumber":99,"author":{"gitId":"Parcly-Taxel"},"content":"    remote \u003d repository.remotes[\"origin\"]"},{"lineNumber":100,"author":{"gitId":"Parcly-Taxel"},"content":"    remote.push([\"refs/heads/master\"], callbacks\u003dkey)"},{"lineNumber":101,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":102,"author":{"gitId":"Parcly-Taxel"},"content":"def read_student_names(file):"},{"lineNumber":103,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"If file ends in .csv, read the CSV file where each username should"},{"lineNumber":104,"author":{"gitId":"Parcly-Taxel"},"content":"    reside in the second column and the first column contains \"student\"."},{"lineNumber":105,"author":{"gitId":"Parcly-Taxel"},"content":"    If not, the file should contain several lines, one username per line."},{"lineNumber":106,"author":{"gitId":"Parcly-Taxel"},"content":"    Return a list of students thus extracted.\"\"\""},{"lineNumber":107,"author":{"gitId":"Parcly-Taxel"},"content":"    with open(file, \u0027r\u0027) as f:"},{"lineNumber":108,"author":{"gitId":"Parcly-Taxel"},"content":"        if not file.endswith(\".csv\"):"},{"lineNumber":109,"author":{"gitId":"Parcly-Taxel"},"content":"            return f.read().splitlines()"},{"lineNumber":110,"author":{"gitId":"Parcly-Taxel"},"content":"        return [row[1] for row in csv.reader(f) if row[0] \u003d\u003d \"student\"]"},{"lineNumber":111,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":112,"author":{"gitId":"Parcly-Taxel"},"content":"def read_credentials(file):"},{"lineNumber":113,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"file contains four lines: author name, email address,"},{"lineNumber":114,"author":{"gitId":"Parcly-Taxel"},"content":"    GitHub username, access token. Extract these fields"},{"lineNumber":115,"author":{"gitId":"Parcly-Taxel"},"content":"    from said file and return a tuple of them.\"\"\""},{"lineNumber":116,"author":{"gitId":"Parcly-Taxel"},"content":"    with open(file, \u0027r\u0027) as f:"},{"lineNumber":117,"author":{"gitId":"Parcly-Taxel"},"content":"        return tuple(f.read().splitlines())"},{"lineNumber":118,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":119,"author":{"gitId":"Parcly-Taxel"},"content":"def print_clashes(clashes):"},{"lineNumber":120,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Print any clashing filenames that arose out of file transfer.\"\"\""},{"lineNumber":121,"author":{"gitId":"Parcly-Taxel"},"content":"    if clashes:"},{"lineNumber":122,"author":{"gitId":"Parcly-Taxel"},"content":"        print(\"Files not transferred:\")"},{"lineNumber":123,"author":{"gitId":"Parcly-Taxel"},"content":"        for clash in clashes:"},{"lineNumber":124,"author":{"gitId":"Parcly-Taxel"},"content":"            print(clash)"},{"lineNumber":125,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":126,"author":{"gitId":"Parcly-Taxel"},"content":"def main():"},{"lineNumber":127,"author":{"gitId":"Parcly-Taxel"},"content":"    \"\"\"Get the CSV file of students\u0027 names and the destination"},{"lineNumber":128,"author":{"gitId":"Parcly-Taxel"},"content":"    repository from the command line, then transfer the files."},{"lineNumber":129,"author":{"gitId":"Parcly-Taxel"},"content":"    Afterwards, commit and push using provided credentials.\"\"\""},{"lineNumber":130,"author":{"gitId":"Parcly-Taxel"},"content":"    parser \u003d argparse.ArgumentParser(description\u003d\"Read a file of \""},{"lineNumber":131,"author":{"gitId":"Parcly-Taxel"},"content":"            \"student GitHub usernames, then transfer files in their \""},{"lineNumber":132,"author":{"gitId":"Parcly-Taxel"},"content":"            \"PE repositories to a given destination repository.\")"},{"lineNumber":133,"author":{"gitId":"Parcly-Taxel"},"content":"    parser.add_argument(\"students\", help\u003d\"CSV or plaintext list of students\")"},{"lineNumber":134,"author":{"gitId":"Parcly-Taxel"},"content":"    parser.add_argument(\"destination\", help\u003d\"destination repository, \""},{"lineNumber":135,"author":{"gitId":"Parcly-Taxel"},"content":"            \"in the form owner/name (e.g. nus-cs2103-AY1920S1/pe)\")"},{"lineNumber":136,"author":{"gitId":"Parcly-Taxel"},"content":"    parser.add_argument(\"credentials\", help\u003d\"credentials file - \""},{"lineNumber":137,"author":{"gitId":"Parcly-Taxel"},"content":"            \"four lines of author, email, username, access token\")"},{"lineNumber":138,"author":{"gitId":"Parcly-Taxel"},"content":"    parser.add_argument(\"-p\", help\u003d\"number of download processes to \""},{"lineNumber":139,"author":{"gitId":"Parcly-Taxel"},"content":"            \"run in parallel (default is number of cores on machine)\","},{"lineNumber":140,"author":{"gitId":"Parcly-Taxel"},"content":"            type\u003dint, default\u003dos.cpu_count())"},{"lineNumber":141,"author":{"gitId":"Parcly-Taxel"},"content":"    args \u003d parser.parse_args()"},{"lineNumber":142,"author":{"gitId":"Parcly-Taxel"},"content":"    students \u003d read_student_names(args.students)"},{"lineNumber":143,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":144,"author":{"gitId":"Parcly-Taxel"},"content":"    AUTHOR, EMAIL, USERNAME, TOKEN \u003d read_credentials(args.credentials)"},{"lineNumber":145,"author":{"gitId":"Parcly-Taxel"},"content":"    user_pass \u003d pygit2.UserPass(USERNAME, TOKEN)"},{"lineNumber":146,"author":{"gitId":"Parcly-Taxel"},"content":"    key \u003d pygit2.RemoteCallbacks(credentials\u003duser_pass)"},{"lineNumber":147,"author":{"gitId":"Parcly-Taxel"},"content":"    processes \u003d 1 if args.p is None or args.p \u003c 1 else args.p"},{"lineNumber":148,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":149,"author":{"gitId":"Parcly-Taxel"},"content":"    endpoint \u003d clone_destination(args.destination, key)"},{"lineNumber":150,"author":{"gitId":"Parcly-Taxel"},"content":"    files_path \u003d make_files_folder(endpoint)"},{"lineNumber":151,"author":{"gitId":"Parcly-Taxel"},"content":"    print_clashes(collate_files(students, files_path, processes))"},{"lineNumber":152,"author":{"gitId":"Parcly-Taxel"},"content":"    commit_and_push(endpoint, AUTHOR, EMAIL, \"Collect PE files\", key)"},{"lineNumber":153,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":154,"author":{"gitId":"Parcly-Taxel"},"content":"if __name__ \u003d\u003d \"__main__\":"},{"lineNumber":155,"author":{"gitId":"Parcly-Taxel"},"content":"    main()"}],"authorContributionMap":{"Parcly-Taxel":155}},{"path":"readme.md","fileType":"md","lines":[{"lineNumber":1,"author":{"gitId":"Parcly-Taxel"},"content":"# FETcher"},{"lineNumber":2,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":3,"author":{"gitId":"Parcly-Taxel"},"content":"[GitHub](https://github.com/Parcly-Taxel/FETcher)"},{"lineNumber":4,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":5,"author":{"gitId":"Parcly-Taxel"},"content":"This repository contains two Python scripts. The first, `fetch.py`, performs **F**il**E T**ransfer for the purposes of [CATcher](https://github.com/CATcher-org/CATcher). It takes from the command line"},{"lineNumber":6,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":7,"author":{"gitId":"Parcly-Taxel"},"content":"* either the location of a CSV file containing student usernames (see `fetcher/data.csv` for how it should be structured), or a regular file containing one username per line to transfer"},{"lineNumber":8,"author":{"gitId":"Parcly-Taxel"},"content":"* a destination repository in the form `owner/name`"},{"lineNumber":9,"author":{"gitId":"Parcly-Taxel"},"content":"* a credentials file, containing four lines of author name, email address, GitHub username and access token, e.g."},{"lineNumber":10,"author":{"gitId":"Parcly-Taxel"},"content":"```"},{"lineNumber":11,"author":{"gitId":"Parcly-Taxel"},"content":"Derpy Hooves"},{"lineNumber":12,"author":{"gitId":"Parcly-Taxel"},"content":"derpy@equestria.net"},{"lineNumber":13,"author":{"gitId":"Parcly-Taxel"},"content":"muffinsmuffins"},{"lineNumber":14,"author":{"gitId":"Parcly-Taxel"},"content":"4f17daf987b3028dd4367f8bef6ec39e929203a8"},{"lineNumber":15,"author":{"gitId":"Parcly-Taxel"},"content":"```"},{"lineNumber":16,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":17,"author":{"gitId":"Parcly-Taxel"},"content":"The script then clones the students\u0027 repositories, transfers their files to a central folder in the destination repository called `files`, commits and pushes. Multiple processes (specified by the `-p` option, defaults to the number of cores on the running machine) can be used in parallel to speed up repository cloning."},{"lineNumber":18,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":19,"author":{"gitId":"Parcly-Taxel"},"content":"An interrupted transfer process can be resumed by passing `remaining` instead of the CSV file as the first argument to `fetch.py`. The file `remaining` is automatically updated with a list of usernames still to process."},{"lineNumber":20,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":21,"author":{"gitId":"Parcly-Taxel"},"content":"Example times for transferring the CS2103/T AY1920S1 cohort (332 students) with 4 processes:"},{"lineNumber":22,"author":{"gitId":"Parcly-Taxel"},"content":"```"},{"lineNumber":23,"author":{"gitId":"Parcly-Taxel"},"content":"real    6m10.815s"},{"lineNumber":24,"author":{"gitId":"Parcly-Taxel"},"content":"user    1m59.742s"},{"lineNumber":25,"author":{"gitId":"Parcly-Taxel"},"content":"sys     0m10.230s"},{"lineNumber":26,"author":{"gitId":"Parcly-Taxel"},"content":"```"},{"lineNumber":27,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":28,"author":{"gitId":"Parcly-Taxel"},"content":"The second script, `fetch-issues.py`, takes from the command line"},{"lineNumber":29,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":30,"author":{"gitId":"Parcly-Taxel"},"content":"* a source and destination repository, both in the form `owner/name`"},{"lineNumber":31,"author":{"gitId":"Parcly-Taxel"},"content":"* a credentials file as in `fetch.py`"},{"lineNumber":32,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":33,"author":{"gitId":"Parcly-Taxel"},"content":"It then"},{"lineNumber":34,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":35,"author":{"gitId":"Parcly-Taxel"},"content":"* downloads the _title_, _body_ and _labels_ of all issues in the source repository using [the GraphQL API](https://developer.github.com/v4) and saves them to `issues.json` as a backup"},{"lineNumber":36,"author":{"gitId":"Parcly-Taxel"},"content":"* creates issues with the same data in the destination repository using the REST API"},{"lineNumber":37,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":38,"author":{"gitId":"Parcly-Taxel"},"content":"Example times for transferring the issues found in the practical exam dry run by the CS2103/T AY1920S1 cohort (3052 issues):"},{"lineNumber":39,"author":{"gitId":"Parcly-Taxel"},"content":"```"},{"lineNumber":40,"author":{"gitId":"Parcly-Taxel"},"content":"real    29m10.705s"},{"lineNumber":41,"author":{"gitId":"Parcly-Taxel"},"content":"user    2m25.138s"},{"lineNumber":42,"author":{"gitId":"Parcly-Taxel"},"content":"sys     0m8.460s"},{"lineNumber":43,"author":{"gitId":"Parcly-Taxel"},"content":"```"},{"lineNumber":44,"author":{"gitId":"Parcly-Taxel"},"content":"Issues continued to be created for six minutes after the program completed."},{"lineNumber":45,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":46,"author":{"gitId":"Parcly-Taxel"},"content":"----"},{"lineNumber":47,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":48,"author":{"gitId":"Parcly-Taxel"},"content":"[Fet](https://en.wikipedia.org/wiki/Fet) is also the name of a Norwegian municipality, quite close to Akershus Fortress."}],"authorContributionMap":{"Parcly-Taxel":48}},{"path":"requirements.txt","fileType":"txt","lines":[{"lineNumber":1,"author":{"gitId":"Parcly-Taxel"},"content":"pygit2"},{"lineNumber":2,"author":{"gitId":"Parcly-Taxel"},"content":"requests"}],"authorContributionMap":{"Parcly-Taxel":2}},{"path":"setup.py","fileType":"py","lines":[{"lineNumber":1,"author":{"gitId":"Parcly-Taxel"},"content":"#!/usr/bin/env python3.7"},{"lineNumber":2,"author":{"gitId":"Parcly-Taxel"},"content":"from setuptools import setup, find_packages"},{"lineNumber":3,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":4,"author":{"gitId":"Parcly-Taxel"},"content":"with open(\u0027readme.md\u0027) as f:"},{"lineNumber":5,"author":{"gitId":"Parcly-Taxel"},"content":"    readme \u003d f.read()"},{"lineNumber":6,"author":{"gitId":"Parcly-Taxel"},"content":"with open(\u0027licence\u0027) as f:"},{"lineNumber":7,"author":{"gitId":"Parcly-Taxel"},"content":"    licence \u003d f.read()"},{"lineNumber":8,"author":{"gitId":"Parcly-Taxel"},"content":""},{"lineNumber":9,"author":{"gitId":"Parcly-Taxel"},"content":"setup("},{"lineNumber":10,"author":{"gitId":"Parcly-Taxel"},"content":"    name\u003d\u0027fetcher\u0027,"},{"lineNumber":11,"author":{"gitId":"Parcly-Taxel"},"content":"    version\u003d\u00271.0.0\u0027,"},{"lineNumber":12,"author":{"gitId":"Parcly-Taxel"},"content":"    description\u003d\u0027Python file transfer between Git repositories\u0027,"},{"lineNumber":13,"author":{"gitId":"Parcly-Taxel"},"content":"    long_description\u003dreadme,"},{"lineNumber":14,"author":{"gitId":"Parcly-Taxel"},"content":"    author\u003d\u0027Jeremy Tan Jie Rui\u0027,"},{"lineNumber":15,"author":{"gitId":"Parcly-Taxel"},"content":"    author_email\u003d\u0027reddeloostw@gmail.com\u0027,"},{"lineNumber":16,"author":{"gitId":"Parcly-Taxel"},"content":"    url\u003d\u0027https://github.com/Parcly-Taxel/fetcher\u0027,"},{"lineNumber":17,"author":{"gitId":"Parcly-Taxel"},"content":"    license\u003dlicence,"},{"lineNumber":18,"author":{"gitId":"Parcly-Taxel"},"content":"    packages\u003dfind_packages(exclude\u003d(\u0027tests\u0027, \u0027docs\u0027))"},{"lineNumber":19,"author":{"gitId":"Parcly-Taxel"},"content":")"}],"authorContributionMap":{"Parcly-Taxel":19}}]
